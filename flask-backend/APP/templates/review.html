<link rel="stylesheet" href="{{url_for('static', filename='css/review.css')}}">
<!------ Include the above in your HEAD tag ---------->

<div class="container" style="margin-top:40px; margin-bottom:60px;">
  <div class="row">
    <h3 class="col text-center">Reviews</h3>
  </div>
  <div class="row" id="review-list">
  </div>
  <div class="row">
    <div class="col-md-6 mb-2">
      <div class="well well-sm">
        <div class="text-right">
          <h4>
            Leave a Review
          </h4>
        </div>

        <div class="row" id="post-review-box">
          <div class="col-md-12">
            <form accept-charset="UTF-8" onsubmit="handleReview(event)">
              <textarea class="form-control animated" name="Review" placeholder="Enter your review here..." rows="5"></textarea>

              <div class="text-right">
                <div class="rating-css">
                  <div class="star-icon">
                    <input type="radio" name="Rating" id="rating1" value="1">
                    <label for="rating1" class="fa fa-star"></label>
                    <input type="radio" name="Rating" id="rating2" value="2">
                    <label for="rating2" class="fa fa-star"></label>
                    <input type="radio" name="Rating" id="rating3" value="3">
                    <label for="rating3" class="fa fa-star"></label>
                    <input type="radio" name="Rating" id="rating4" value="4">
                    <label for="rating4" class="fa fa-star"></label>
                    <input type="radio" name="Rating" id="rating5" value="5" checked>
                    <label for="rating5" class="fa fa-star"></label>
                  </div>
                </div>
                <button class="btn btn-success btn-lg" type="submit">Add</button>
              </div>
            </form>
          </div>
        </div>
      </div>

    </div>
  </div>
</div>
<script>
  function handleReview(event) {
    event.preventDefault();
    let reviewData = new FormData(event.target);
    var object = {};
    reviewData.forEach(function(value, key) {
      object[key] = value;
    });
    object.Item_Id = document.getElementById('itemid').value;
    fetch('/api/item/write_review/', {
      method: "POST",
      headers: {
        "content-type": "application/json",
      },
      body: JSON.stringify(object)
    }).then(function(response) {
      return response.json();
    }).then(function(response) {
      console.log(response);
      if (response.message == "success") {
        addReviewElement(response.review);
      } else {
        alert(JSON.stringify(response));
      }
    })
  }

  function addReviewElement(reviewData) {
    if (reviewData.Name == null) {
      reviewData.Name = 'You'
    }
    let newReviewElement = document.createElement("div");
    newReviewElement.innerHTML = `
      <div class="well well-sm">
        <div class="text-right">
          <h4>
            ${reviewData.Name}
          </h4>
          <p class="font-weight-light">${(new Date(reviewData.Date)).toDateString()}</p>
        </div>
        <div class="text-right">
          ${reviewData.Review}
        </div>
        <div>
          Rating : <i class="fa fa-star ${(reviewData.Rating>0)?'review-star-selected':'review-star-not-selected'}"></i><i class="fa fa-star ${(reviewData.Rating>1)?'review-star-selected':'review-star-not-selected'}"></i><i class="fa fa-star ${(reviewData.Rating>2)?'review-star-selected':'review-star-not-selected'}"></i><i class="fa fa-star ${(reviewData.Rating>3)?'review-star-selected':'review-star-not-selected'}"></i><i class="fa fa-star ${(reviewData.Rating>4)?'review-star-selected':'review-star-not-selected'}"></i>
        </div>
      </div>
    `
    newReviewElement.setAttribute('class', 'col-md-6 mb-2');
    document.getElementById('review-list').append(newReviewElement);
  }
  document.addEventListener('DOMContentLoaded', function() {
    let Item_Id = document.getElementById('itemid').value;
    console.log(Item_Id);
    let reviewsFromApi = [];
    fetch('/api/item/get_review', {
      method: "POST",
      headers: {
        "content-type": "application/json",
      },
      body: JSON.stringify({
        Item_Id
      })
    }).then(function(response) {
      return response.json();
    }).then(function(response) {
      if (response.message == "success") {
        reviewsFromApi = response.reviews;
        console.log(reviewsFromApi);
        reviewsFromApi.forEach(function(review) {
          addReviewElement(review);
        })
      } else {
        console.log("Something went wrong in review api call");
      }
    }).catch(function(error) {
      console.log(error);
    })
  });
</script>